<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Resgate da Vila: Jogo FPS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Orbitron', sans-serif;
            color: white;
        }
        canvas {
            display: block;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            pointer-events: none; /* Allows clicks to go through to the canvas */
        }
        .modal {
            background-color: rgba(0, 10, 30, 0.85);
            border: 2px solid #0ff;
            box-shadow: 0 0 25px #0ff;
            border-radius: 15px;
            padding: 30px;
            pointer-events: all; /* Re-enable pointer events for modals */
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        h1 { font-size: 2.5rem; color: #f0f; text-shadow: 0 0 10px #f0f; }
        p { font-size: 1.2rem; }
        button {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            padding: 15px 30px;
            background-color: #f0f;
            color: #000;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-shadow: 0 0 5px #fff;
            transition: all 0.2s ease;
            box-shadow: 0 0 15px #f0f;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px #f0f;
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            width: calc(100% - 20px);
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            text-shadow: 0 0 5px #000;
            pointer-events: none;
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid #0ff;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }
        #boss-hud { display: none; }
        #boss-hp-bar {
            width: 50%;
            height: 30px;
            background-color: #555;
            border-radius: 15px;
            margin: 10px auto;
            overflow: hidden;
            border: 2px solid #f00;
        }
        #boss-hp {
            width: 100%;
            height: 100%;
            background-color: #f00;
            transition: width 0.5s ease;
        }

        /* Mobile Controls */
        #mobile-controls { display: none; }
        #joystick-area {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            background-color: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 50%;
        }
        #joystick-knob {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: rgba(0, 255, 255, 0.4);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #shoot-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 0, 255, 0.5);
            border: 2px solid #f0f;
            border-radius: 50%;
        }
        @media (max-width: 768px) {
            #mobile-controls { display: block; }
        }
    </style>
</head>
<body>

    <div id="crosshair"></div>
    <div id="hud">
        <div id="mission-display">Missão: 1</div>
        <div id="enemies-display">Inimigos: 10</div>
        <div id="stars-display">★ 0</div>
    </div>
    
    <div id="start-screen" class="ui-overlay">
        <div class="modal">
            <h1>Resgate da Vila</h1>
            <p>Os inimigos invadiram! Derrote todos eles e o chefe final para salvar a vila.</p>
            <p><b>PC:</b> WASD/Setas para mover, Mouse para mirar, Clique para atirar.<br><b>Celular:</b> Use os controles na tela.</p>
            <button id="start-button">INICIAR JOGO</button>
        </div>
    </div>
    
    <div id="mission-complete-screen" class="ui-overlay" style="display: none;">
        <div class="modal">
            <h1 id="mission-complete-title">MISSÃO 1 COMPLETA</h1>
            <p>Você ganhou ★★★!</p>
            <button id="next-mission-button">AVANÇAR</button>
        </div>
    </div>

    <div id="game-over-screen" class="ui-overlay" style="display: none;">
         <div class="modal">
            <h1>FIM DE JOGO</h1>
            <button id="restart-button-gameover">TENTAR NOVAMENTE</button>
        </div>
    </div>

    <div id="victory-screen" class="ui-overlay" style="display: none;">
        <div class="modal">
            <h1>PARABÉNS!</h1>
            <p>Você derrotou o chefe final e salvou a vila! Você é um herói!</p>
            <button id="restart-button-victory">JOGAR NOVAMENTE</button>
        </div>
    </div>

    <div id="boss-hud" class="ui-overlay" style="justify-content: flex-start; padding-top: 20px;">
        <h2>CHEFE FINAL</h2>
        <div id="boss-hp-bar"><div id="boss-hp"></div></div>
    </div>

    <div id="mobile-controls">
        <div id="joystick-area"><div id="joystick-knob"></div></div>
        <div id="shoot-button"></div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
                       "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/" } }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- Elementos da UI ---
        const startButton = document.getElementById('start-button');
        const nextMissionButton = document.getElementById('next-mission-button');
        const missionDisplay = document.getElementById('mission-display');
        const enemiesDisplay = document.getElementById('enemies-display');
        const starsDisplay = document.getElementById('stars-display');
        const missionCompleteTitle = document.getElementById('mission-complete-title');
        const bossHpElement = document.getElementById('boss-hp');
        // Telas
        const screens = {
            start: document.getElementById('start-screen'),
            missionComplete: document.getElementById('mission-complete-screen'),
            gameOver: document.getElementById('game-over-screen'),
            victory: document.getElementById('victory-screen'),
            bossHud: document.getElementById('boss-hud')
        };
        document.getElementById('restart-button-gameover').addEventListener('click', () => location.reload());
        document.getElementById('restart-button-victory').addEventListener('click', () => location.reload());

        // --- Configurações do Jogo ---
        let camera, scene, renderer, controls;
        let clock = new THREE.Clock();
        const objects = [];
        let raycaster;

        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();

        let enemies = [];
        let projectiles = [];
        let currentMission = 1;
        let totalStars = 0;
        let boss = null;
        const BOSS_MAX_HP = 300;

        // --- Inicialização ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 0, 200);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 10;
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new PointerLockControls(camera, renderer.domElement);
            scene.add(controls.getObject());

            // Luzes
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 50);
            scene.add(directionalLight);

            raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, -1, 0), 0, 10);
            
            setupEventListeners();
            setupMission(currentMission);
        }
        
        function setupMission(missionNumber) {
            // Limpar cena anterior
            objects.forEach(o => scene.remove(o));
            enemies.forEach(e => scene.remove(e.mesh));
            objects.length = 0;
            enemies.length = 0;
            if(boss) scene.remove(boss.mesh);
            boss = null;
            
            screens.bossHud.style.display = 'none';

            // Chão
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(500, 500),
                new THREE.MeshLambertMaterial({ color: 0x4a7c59 })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            objects.push(floor);
            
            // Criar cenário baseado na missão
            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0x886644 });
            for(let i = 0; i < missionNumber * 3; i++) {
                const wall = new THREE.Mesh(new THREE.BoxGeometry(10, 20, 10), wallMaterial);
                wall.position.set(
                    (Math.random() - 0.5) * 400,
                    10,
                    (Math.random() - 0.5) * 400
                );
                scene.add(wall);
                objects.push(wall);
            }

            // Inimigos
            if (missionNumber < 10) {
                const enemyCount = 10; // 10 inimigos por fase
                const enemyMaterial = new THREE.MeshLambertMaterial({ color: 0x0000ff });
                for (let i = 0; i < enemyCount; i++) {
                    const enemyMesh = new THREE.Mesh(new THREE.BoxGeometry(5, 5, 5), enemyMaterial);
                    enemyMesh.position.set(
                        (Math.random() - 0.5) * 300, 2.5, (Math.random() - 0.5) * 300);
                    scene.add(enemyMesh);
                    enemies.push({ mesh: enemyMesh, hp: 1 });
                }
            } else { // Missão 10: Chefe
                screens.bossHud.style.display = 'block';
                const bossMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
                const bossMesh = new THREE.Mesh(new THREE.BoxGeometry(20, 20, 20), bossMaterial);
                bossMesh.position.set(0, 10, -100);
                scene.add(bossMesh);
                boss = { mesh: bossMesh, hp: BOSS_MAX_HP, lastAttack: 0 };
            }
            updateUI();
        }

        function updateUI() {
            missionDisplay.textContent = `Missão: ${currentMission}`;
            starsDisplay.textContent = `★ ${totalStars}`;
            if (currentMission < 10) {
                 enemiesDisplay.textContent = `Inimigos: ${enemies.length}`;
            } else {
                 enemiesDisplay.textContent = 'Chefe Final';
                 if(boss) {
                    const hpPercent = (boss.hp / BOSS_MAX_HP) * 100;
                    bossHpElement.style.width = `${hpPercent}%`;
                 }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (controls.isLocked) {
                handlePlayerMovement(delta);
                updateEnemies(delta);
                updateProjectiles(delta);
            }

            renderer.render(scene, camera);
        }
        
        // --- Lógica do Jogo ---

        function shoot() {
            const bulletRaycaster = new THREE.Raycaster();
            bulletRaycaster.setFromCamera({x: 0, y: 0}, camera);
            
            const enemyMeshes = enemies.map(e => e.mesh);
            if (boss) enemyMeshes.push(boss.mesh);

            const intersects = bulletRaycaster.intersectObjects(enemyMeshes);

            if (intersects.length > 0) {
                const target = intersects[0].object;
                
                let hit = false;
                // Atingiu inimigo normal?
                for (let i = enemies.length - 1; i >= 0; i--) {
                    if (enemies[i].mesh === target) {
                        scene.remove(enemies[i].mesh);
                        enemies.splice(i, 1);
                        hit = true;
                        break;
                    }
                }
                
                // Atingiu o chefe?
                if (!hit && boss && boss.mesh === target) {
                    boss.hp -= 10;
                    if (boss.hp <= 0) {
                        scene.remove(boss.mesh);
                        boss = null;
                        screens.victory.style.display = 'flex';
                        controls.unlock();
                    }
                }

                updateUI();
                checkMissionComplete();
            }
        }

        function updateEnemies(delta) {
            // Inimigos normais
            enemies.forEach(enemy => {
                enemy.mesh.lookAt(camera.position);
            });
            
            // Chefe
            if(boss && controls.isLocked) {
                boss.mesh.rotation.y += delta;
                boss.mesh.lookAt(camera.position);

                if(clock.getElapsedTime() - boss.lastAttack > 2) { // Ataca a cada 2s
                    boss.lastAttack = clock.getElapsedTime();
                    const projectileGeo = new THREE.SphereGeometry(2, 8, 8);
                    const projectileMat = new THREE.MeshLambertMaterial({color: 0xff8c00});
                    const projectile = new THREE.Mesh(projectileGeo, projectileMat);
                    
                    const vector = new THREE.Vector3();
                    camera.getWorldPosition(vector);
                    projectile.position.copy(boss.mesh.position);
                    projectile.lookAt(vector);
                    
                    projectiles.push({mesh: projectile, velocity: projectile.getWorldDirection(new THREE.Vector3()).multiplyScalar(80)});
                    scene.add(projectile);
                }
            }
        }

        function updateProjectiles(delta){
            for(let i = projectiles.length - 1; i >= 0; i--){
                const p = projectiles[i];
                p.mesh.position.add(p.velocity.clone().multiplyScalar(delta));

                // Colisão do projétil com o jogador
                if(p.mesh.position.distanceTo(camera.position) < 5){
                     scene.remove(p.mesh);
                     projectiles.splice(i, 1);
                     screens.gameOver.style.display = 'flex';
                     controls.unlock();
                }

                // Remove se estiver longe
                if(p.mesh.position.length() > 500){
                    scene.remove(p.mesh);
                    projectiles.splice(i, 1);
                }
            }
        }

        function checkMissionComplete() {
            if (currentMission < 10 && enemies.length === 0) {
                totalStars += 3;
                missionCompleteTitle.textContent = `MISSÃO ${currentMission} COMPLETA`;
                screens.missionComplete.style.display = 'flex';
                controls.unlock();
            }
        }

        // --- Controles e Eventos ---

        function handlePlayerMovement(delta) {
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;

            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

            controls.moveRight(-velocity.x * delta);
            controls.moveForward(-velocity.z * delta);
        }

        function setupEventListeners() {
            startButton.addEventListener('click', () => {
                screens.start.style.display = 'none';
                controls.lock();
            });
            
            nextMissionButton.addEventListener('click', () => {
                currentMission++;
                setupMission(currentMission);
                screens.missionComplete.style.display = 'none';
                controls.lock();
            });

            // Controles PC
            document.addEventListener('keydown', (event) => {
                switch (event.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = true; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = true; break;
                    case 'ArrowRight': case 'KeyD': moveRight = true; break;
                }
            });
            document.addEventListener('keyup', (event) => {
                switch (event.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = false; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = false; break;
                    case 'ArrowRight': case 'KeyD': moveRight = false; break;
                }
            });
            document.addEventListener('click', () => { if (controls.isLocked) shoot(); });
            
            // --- Controles Mobile ---
            const joystickArea = document.getElementById('joystick-area');
            const joystickKnob = document.getElementById('joystick-knob');
            const shootButton = document.getElementById('shoot-button');
            let joyStick = { active: false, initialX: 0, initialY: 0 };
            
            joystickArea.addEventListener('touchstart', (e) => {
                joyStick.active = true;
                const touch = e.touches[0];
                joyStick.initialX = touch.clientX;
                joyStick.initialY = touch.clientY;
            }, { passive: false });

            joystickArea.addEventListener('touchmove', (e) => {
                if(!joyStick.active) return;
                const touch = e.touches[0];
                const deltaX = touch.clientX - joyStick.initialX;
                const deltaY = touch.clientY - joyStick.initialY;
                
                moveForward = deltaY < -20;
                moveBackward = deltaY > 20;
                moveLeft = deltaX < -20;
                moveRight = deltaX > 20;

                const maxDist = 45;
                const clampedX = Math.max(-maxDist, Math.min(maxDist, deltaX));
                const clampedY = Math.max(-maxDist, Math.min(maxDist, deltaY));
                joystickKnob.style.transform = `translate(-50%, -50%) translate(${clampedX}px, ${clampedY}px)`;
            }, { passive: false });

            joystickArea.addEventListener('touchend', (e) => {
                joyStick.active = false;
                moveForward = moveBackward = moveLeft = moveRight = false;
                joystickKnob.style.transform = `translate(-50%, -50%)`;
            });
            
            shootButton.addEventListener('touchstart', (e) => { e.preventDefault(); if(controls.isLocked) shoot(); }, { passive: false });

            // Rotação da câmera no celular
            let lastX = 0, lastY = 0, isDragging = false;
            document.addEventListener('touchstart', (e) => {
                if (e.target !== joystickArea && e.target !== joystickKnob && e.target !== shootButton) {
                    isDragging = true;
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;
                }
            });
            document.addEventListener('touchmove', (e) => {
                if(isDragging && controls.isLocked){
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - lastX;
                    const deltaY = touch.clientY - lastY;
                    lastX = touch.clientX;
                    lastY = touch.clientY;
                    controls.getObject().rotation.y -= deltaX * 0.002;
                    controls.getObject().children[0].rotation.x -= deltaY * 0.002;
                     // Limitar rotação vertical
                    controls.getObject().children[0].rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, controls.getObject().children[0].rotation.x));
                }
            });
            document.addEventListener('touchend', () => { isDragging = false; });


            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        init();
        animate();
    </script>
</body>
</html>
